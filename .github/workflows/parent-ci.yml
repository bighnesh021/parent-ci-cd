name: Parent â€“ Build & Deploy Mule Application

on:
  repository_dispatch:
    types: [trigger-build]

env:
  MAVEN_OPTS: -Xmx1024m

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - run: mkdir -p /tmp/mule-settings && cp settings/settings.xml /tmp/mule-settings/settings.xml
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        cache: maven
    - run: mvn -B clean package -s /tmp/mule-settings/settings.xml -DskipTests=false
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}
    - uses: actions/upload-artifact@v4
      with:
        name: mule-artifact
        path: target/*.jar

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3
    - run: mkdir -p /tmp/mule-settings && cp settings/settings.xml /tmp/mule-settings/settings.xml
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}
    - uses: actions/download-artifact@v4
      with:
        name: mule-artifact
        path: target/
    - run: mvn -B test -s /tmp/mule-settings/settings.xml
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}

  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v3
    - run: mkdir -p /tmp/mule-settings && cp settings/settings.xml /tmp/mule-settings/settings.xml
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}
    - run: mvn -B deploy -s /tmp/mule-settings/settings.xml -DskipTests=true
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}

  deploy:
    runs-on: ubuntu-latest
    needs: publish
    steps:
    - uses: actions/checkout@v3
    - run: mkdir -p /tmp/mule-settings && cp settings/settings.xml /tmp/mule-settings/settings.xml
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}
    - run: |
        mvn -B mule:deploy -s /tmp/mule-settings/settings.xml \
        -Duser="${{ secrets.ANYPNT_USERNAME }}" \
        -Dpass="${{ secrets.ANYPNT_PASSWORD }}" \
        -Denvironment="${{ github.event.client_payload.environment }}" \
        -DtargetName="${{ github.event.client_payload.targetName }}" \
        -DappName="${{ github.event.client_payload.appName }}" \
        -Dreplicas="${{ github.event.client_payload.replicas }}" \
        -DvCores="${{ github.event.client_payload.vCores }}"
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
    - run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"Deployment Completed\nEnvironment: '${{ github.event.client_payload.environment }}'\nApp: '${{ github.event.client_payload.appName }}'\nStatus: '${{ needs.deploy.result }}'"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
    - uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Mule Deploy Status - ${{ github.event.client_payload.appName }}"
        to: ${{ secrets.EMAIL_TO }}
        from: "Mule CI/CD Pipeline <${{ secrets.EMAIL_USERNAME }}>"
        body: |
          Deployment Report:
          Application: ${{ github.event.client_payload.appName }}
          Environment: ${{ github.event.client_payload.environment }}
          Target: ${{ github.event.client_payload.targetName }}
          Replicas: ${{ github.event.client_payload.replicas }}
          vCores: ${{ github.event.client_payload.vCores }}
          Status: ${{ needs.deploy.result }}
          Triggered By: ${{ github.event.client_payload.repo }}
