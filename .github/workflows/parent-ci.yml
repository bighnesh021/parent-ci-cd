name: Parent â€“ Build & Deploy Mule Application

on:
  repository_dispatch:
    types: [trigger-build]

env:
  MAVEN_OPTS: -Xmx1024m

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout child repo
      uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'

    - name: Build Mule App
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}
      run: |
        mvn -B clean package -s settings/settings.xml -DskipTests=false

    - uses: actions/upload-artifact@v4
      with:
        name: mule-artifact
        path: target/*.jar


  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}

    - uses: actions/download-artifact@v4
      with:
        name: mule-artifact
        path: target/

    - name: Run MUnit Tests
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}
      run: |
        mvn -B test -s settings/settings.xml


  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}

    - name: Publish Artifact to Exchange
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}
      run: |
        mvn -B deploy -s settings/settings.xml -DskipTests=true


  deploy:
    runs-on: ubuntu-latest
    needs: publish
    steps:
    - uses: actions/checkout@v3
      with:
        repository: ${{ github.event.client_payload.repo }}
        token: ${{ secrets.PAT_TOKEN }}

    - name: Deploy to CloudHub 2.0
      env:
        ANYPNT_USERNAME: ${{ secrets.ANYPNT_USERNAME }}
        ANYPNT_PASSWORD: ${{ secrets.ANYPNT_PASSWORD }}
      run: |
        mvn -B mule:deploy -s settings/settings.xml \
          -Denvironment="${{ github.event.client_payload.environment }}" \
          -DtargetName="${{ github.event.client_payload.targetName }}" \
          -DappName="${{ github.event.client_payload.appName }}" \
          -Dreplicas="${{ github.event.client_payload.replicas }}" \
          -DvCores="${{ github.event.client_payload.vCores }}"


  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
    - name: Slack Notification
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"ðŸš€ Mule Deployment Completed!\nEnvironment: '${{ github.event.client_payload.environment }}'\nApp: '${{ github.event.client_payload.appName }}'\nStatus: '${{ needs.deploy.result }}'"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Mule Deploy Status - ${{ github.event.client_payload.appName }}"
        to: ${{ secrets.EMAIL_TO }}
        from: "Mule CI/CD Pipeline <${{ secrets.EMAIL_USERNAME }}>"
        body: |
          Deployment Report:
          ------------------------
          Application: ${{ github.event.client_payload.appName }}
          Environment: ${{ github.event.client_payload.environment }}
          Target: ${{ github.event.client_payload.targetName }}
          Replicas: ${{ github.event.client_payload.replicas }}
          vCores: ${{ github.event.client_payload.vCores }}
          Status: ${{ needs.deploy.result }}
          Triggered By repo: ${{ github.event.client_payload.repo }}
